<modification>    <id>Cool Filter</id>    <version>1.5.5.1.3</version>    <vqmver>2.1.x</vqmver>    <file name="admin/controller/common/menu.php" error="log">        <operation>            <search position="after"><![CDATA[            $data['text_country'] = $this->language->get('text_country');            ]]></search>            <add><![CDATA[		// Start coolfilter		$data['text_coolfilter'] = $this->language->get('text_coolfilter');		$data['text_coolfilter_group'] = $this->language->get('text_coolfilter_group');		// End coolfilter            ]]></add>        </operation>        <operation>            <search position="after"><![CDATA[            $data['category'] = $this->url->link('catalog/category', 'token=' . $this->session->data['token'], 'SSL');            ]]></search>            <add><![CDATA[// Start coolfilter            $data['coolfilter'] = $this->url->link('catalog/coolfilter', 'token=' . $this->session->data['token'], 'SSL');            $data['coolfilter_group'] = $this->url->link('catalog/coolfilter_group', 'token=' . $this->session->data['token'], 'SSL');            // End coolfilter            ]]></add>        </operation>    </file>    <file name="admin/language/russian/common/menu.php" error="log">        <operation>            <search position="after"><![CDATA[            $_['text_category']            ]]></search>            <add><![CDATA[// Start coolfilter$_['text_coolfilter']                       = 'Фильтр товаров';$_['text_coolfilter_group']                 = 'Группы фильтров';// End coolfilter            ]]></add>        </operation>    </file>    <file name="admin/language/english/common/menu.php" error="log">        <operation>            <search position="after"><![CDATA[            $_['text_category']            ]]></search>            <add><![CDATA[// Start coolfilter$_['text_coolfilter']                       = 'coolfilter';$_['text_coolfilter_group']                 = 'coolfilter group';// End coolfilter            ]]></add>        </operation>    </file>    <file name="admin/view/template/common/menu.tpl" error="log">        <operation>            <search position="after"><![CDATA[            <li><a href="<?php echo $product; ?>"><?php echo $text_product; ?></a></li>            ]]></search>            <add><![CDATA[          <!--Start coolfilter-->          <?php if($coolfilter != ''){ ?>          <li>			<a class="parent"><?php echo $text_coolfilter; ?></a>			<ul>				<li><a href="<?php echo $coolfilter; ?>"><?php echo $text_coolfilter; ?></a></li>				<li><a href="<?php echo $coolfilter_group; ?>"><?php echo $text_coolfilter_group; ?></a></li>			</ul>		  </li>          <?php } ?>          <!--End coolfilter-->            ]]></add>        </operation>    </file>    <file name="catalog/controller/product/category.php" error="log">        <operation>            <search position="before" index="1"><![CDATA[            if (isset($this->request->get['page'])) {            ]]></search>            <add><![CDATA[// Start coolfilter	   if (isset($this->request->get['coolfilter'])) {	        $coolfilter = $this->request->get['coolfilter'];	   } else {	        $coolfilter = '';	   }// End coolfilter            ]]></add>        </operation>        <operation>            <search position="before" index="2,3,4"><![CDATA[            if (isset($this->request->get['limit'])) {            ]]></search>            <add><![CDATA[	        // Start coolfilter 1	        if (isset($this->request->get['coolfilter'])) {	          $url .= '&coolfilter=' . $this->request->get['coolfilter'];	        }	        // End coolfilter            ]]></add>        </operation>        <operation>            <search position="before" index="2"><![CDATA[            if (isset($this->request->get['page'])) {            ]]></search>            <add><![CDATA[	        // Start coolfilter 2	        if (isset($this->request->get['coolfilter'])) {	          $url .= '&coolfilter=' . $this->request->get['coolfilter'];	        }	        // End coolfilter            ]]></add>        </operation>        <operation>            <search position="before"><![CDATA[            'href'  => $this->url->link('product/category', 'path=' . $this->request->get['path'] . '_' . $result['category_id'] . $url)            ]]></search>            <add><![CDATA[// Start coolfilter					'count' => $this->model_catalog_product->getTotalProducts($filter_data),// End coolfilter            ]]></add>        </operation>        <operation>            <search position="replace" index="1"><![CDATA[			 if ($category_info) {            ]]></search>            <add><![CDATA[	        // Start coolfilter 3				if ($category_info || $path_id == 0) {					if ($path_id == 0) {						$category_info['name'] = $this->language->get('text_all_products');					}	        // End coolfilter            ]]></add>        </operation>        <operation>            <search position="replace" index="1"><![CDATA[			 if ($category_info) {            ]]></search>            <add><![CDATA[	        // Start coolfilter 4				if ($category_info || $category_id == 0) {					if ($category_id == 0) {						$category_info = array('name' => $this->language->get('text_all_products'),							'seo_title' => '',							'meta_description' => '',							'meta_keyword' => '',							'seo_h1' => $this->language->get('text_all_products'),							'image' => '',							'description' => '');					}	        // End coolfilter            ]]></add>        </operation>        <operation>            <search position="replace" index="1"><![CDATA[			'filter_sub_category' => true            ]]></search>            <add><![CDATA[			'filter_sub_category' => true,			// Start coolfilter			'coolfilter' => $coolfilter	        // End coolfilter            ]]></add>        </operation>        <operation>            <search position="replace" index="1"><![CDATA[			'limit'              => $limit            ]]></search>            <add><![CDATA[			'limit' => $limit,			// Start coolfilter			'coolfilter' => $coolfilter	        // End coolfilter            ]]></add>        </operation>        <operation>            <search position="before"><![CDATA[$data['sorts'] = array();]]></search>            <add><![CDATA[			// Start coolfilter			if (isset($this->request->get['coolfilter'])) {				$url .= '&coolfilter=' . $this->request->get['coolfilter'];			}			// End coolfilter            ]]></add>        </operation>        <operation>            <search position="before"><![CDATA[$pagination = new Pagination();]]></search>            <add><![CDATA[			// Start coolfilter			if (isset($this->request->get['coolfilter'])) {				$url .= '&coolfilter=' . $this->request->get['coolfilter'];			}			// End coolfilter            ]]></add>        </operation>        <operation>            <search position="before"><![CDATA[$data['limits'] = array();]]></search>            <add><![CDATA[			// Start coolfilter			if (isset($this->request->get['coolfilter'])) {				$url .= '&coolfilter=' . $this->request->get['coolfilter'];			}			// End coolfilter            ]]></add>        </operation>    </file>    <file name="catalog/model/catalog/product.php" error="log">        <operation>            <search position="before"><![CDATA[$sql = "SELECT p.product_id, (SELECT AVG(rating) AS total FROM " . DB_PREFIX . "review r1 WHERE r1.product_id = p.product_id AND r1.status = '1' GROUP BY r1.product_id) AS rating, (SELECT price FROM " . DB_PREFIX . "product_discount pd2 WHERE pd2.product_id = p.product_id AND pd2.customer_group_id = '" . (int)$this->config->get('config_customer_group_id') . "' AND pd2.quantity = '1' AND ((pd2.date_start = '0000-00-00' OR pd2.date_start < NOW()) AND (pd2.date_end = '0000-00-00' OR pd2.date_end > NOW())) ORDER BY pd2.priority ASC, pd2.price ASC LIMIT 1) AS discount, (SELECT price FROM " . DB_PREFIX . "product_special ps WHERE ps.product_id = p.product_id AND ps.customer_group_id = '" . (int)$this->config->get('config_customer_group_id') . "' AND ((ps.date_start = '0000-00-00' OR ps.date_start < NOW()) AND (ps.date_end = '0000-00-00' OR ps.date_end > NOW())) ORDER BY ps.priority ASC, ps.price ASC LIMIT 1) AS special";]]></search>            <add><![CDATA[	// Start coolfilter			if (!empty($data['coolfilter'])) {				$coolfilter = $data['coolfilter'];			} else {				$coolfilter = 0;			}						$currency_value = $this->currency->getValue();			$tax_rate = $this->tax->getTax(100, 9);						$sql_add_table_prices = '';			$sql_where_prices = '';			$sql_where_manufacteurs = '';			$sql_add_table_options = '';			$sql_where_options = '';			$sql_add_table_attributes = '';			$sql_where_attributes = '';			//standart filter			$sql_add_table_parameters = '';			$sql_where_parameters = '';			//standart filter			if ($coolfilter) {												  foreach (explode(';', $coolfilter) as $option) {				$values = explode(':', $option);												if ($values[0] == 'm' && preg_match('/^[,0-9]+$/i', $values[1])) {					$sql_where_manufacteurs = ' AND p.manufacturer_id IN (' . $this->db->escape($values[1]) . ')';				}				if (preg_match('/o_\d+/', $values[0]) && preg_match('/^[,0-9]+$/i', $values[1])) {					$option_id = $this->db->escape($values[0]);					$sql_add_table_options .= ' LEFT JOIN ' . DB_PREFIX . 'product_option_value pov' . $option_id . ' ON (p.product_id = pov' . $option_id . '.product_id)';					$sql_where_options .= ' AND pov' . $option_id . '.option_value_id IN (' . $this->db->escape($values[1]) .') AND (pov' . $option_id . '.subtract=0 OR pov' . $option_id . '.subtract=1 AND pov' . $option_id . '.quantity > 0)';				}								if (preg_match('/a_\d+/', $values[0])) {				     				$attribute_id = $this->db->escape($values[0]);					$sql_add_table_attributes .= " LEFT JOIN " . DB_PREFIX . "product_attribute atr" . $attribute_id . " ON (p.product_id = atr" . $attribute_id . ".product_id)";					$get_id = explode("_", $values[0]);										$values[1] = explode(",", $values[1]);					for ($i = 0; $i < count($values[1]); $i++) {						$values[1][$i] = $this->db->escape($values[1][$i]);					}										$values[1] = "'" . implode("','", $values[1]) . "'";										$sql_where_attributes .= " AND (atr" . $attribute_id . ".language_id = '" . (int)$this->config->get('config_language_id') . "' AND atr" . $attribute_id . ".attribute_id = '" . (int)$get_id[1] . "' AND atr" . $attribute_id . ".text IN (" . $values[1] . "))";				}								if ($values[0] == 'p') {								$values[1] = explode(",", $values[1]);					if (!isset($values[1][0])) {						$values[1][0] = 0;					} else {						$values[1][0] /= $currency_value;					}										if (!isset($values[1][1])) {						$values[1][1] = 9999999999;					} else {						$values[1][1] /= $currency_value;					}										for ($i = 0; $i < 2; $i++) {						$values[1][$i] = $this->db->escape($values[1][$i]);					}					/*					if (!empty($data['coolfilter_category_id'])) {						$category_id = ' AND ct.category_id IN (' . $data['coolfilter_category_id'] . ')';					} else {						$category_id = '';					}*/										$category_id = '';																			$sql_add_table_prices  = " 									  LEFT JOIN " . DB_PREFIX . "product_discount pd2 ON p.product_id = pd2.product_id 										AND pd2.customer_group_id = '" . (int)$this->config->get('config_customer_group_id') . "' 										AND pd2.quantity <= '1' AND (pd2.date_start <= NOW() OR pd2.date_start = '0000-00-00') 										AND (pd2.date_end >= NOW() OR pd2.date_end = '0000-00-00') 									  LEFT JOIN " . DB_PREFIX . "product_special ps ON (p.product_id = ps.product_id) 										AND ps.customer_group_id = '" . (int)$this->config->get('config_customer_group_id') . "' 										AND (ps.date_start <= NOW() OR ps.date_start = '0000-00-00') 										AND (ps.date_end >= NOW() OR ps.date_end = '0000-00-00') 										     ";										 					$sql_where_prices  =  " AND LEAST(IF(p.price, p.price, 9999999), IF(pd2.price, pd2.price, 9999999), IF(ps.price, ps.price, 9999999)) >= '" .$values[1][0] . "' 											    AND LEAST(IF(p.price, p.price, 9999999), IF(pd2.price, pd2.price, 9999999), IF(ps.price, ps.price, 9999999)) <= '" .$values[1][1] . "'															                            AND p.status = '1' AND p.date_available <= NOW() ";										}				//standart filter				if (preg_match('/p_\d+/', $values[0]) && preg_match('/^[,0-9]+$/i', $values[1])) {					$parameter_id = $this->db->escape($values[0]);																	$sql_add_table_parameters .= " LEFT JOIN " . DB_PREFIX . "product_filter par" . $parameter_id . " ON (p.product_id = par" . $parameter_id . ".product_id) LEFT JOIN  " . DB_PREFIX . "filter_description fd" . $parameter_id . "  ON (par" . $parameter_id . ".filter_id = fd" . $parameter_id . ".filter_id) ";					$get_id = explode("_", $values[0]);										$values[1] = explode(",", $values[1]);					for ($i = 0; $i < count($values[1]); $i++) {						$values[1][$i] = $this->db->escape($values[1][$i]);																		}										$values[1] = "'" . implode("','", $values[1]) . "'";															$sql_where_parameters .= " AND (fd" . $parameter_id . ".language_id = '" . (int)$this->config->get('config_language_id') . "' AND par" . $parameter_id . ".filter_id IN (" . $values[1] . "))";														}				//standart filter				}			  }						// End coolfilter   	]]></add>        </operation>        <operation>            <search position="after" index="2" offset="1"><![CDATA[$sql .= " FROM " . DB_PREFIX . "product p";]]></search>            <add><![CDATA[	   // start coolfilter		$sql .= $sql_add_table_options;		$sql .= $sql_add_table_attributes;		$sql .= $sql_add_table_prices;		$sql .= $sql_add_table_parameters;							// End coolfilter		]]></add>        </operation>        <operation>            <search position="before" index="2"><![CDATA[$sql .= " GROUP BY p.product_id";]]></search>            <add><![CDATA[ // start coolfilter	    $sql .= $sql_where_manufacteurs;		$sql .= $sql_where_attributes;		$sql .= $sql_where_options;		$sql .= $sql_where_prices;		$sql .= $sql_where_parameters; ]]></add>        </operation>        <operation>            <search position="replace"><![CDATA[public function getTotalProducts($data = array()) {]]></search>            <add><![CDATA[	    public function getTotalProducts($data = array(), $coolfilter = 0) {            ]]></add>        </operation>        <operation>            <search position="before"><![CDATA[$sql = "SELECT COUNT(DISTINCT p.product_id) AS total";]]></search>            <add><![CDATA[  // Start coolfilter 5			if (!empty($data['coolfilter'])) {			$coolfilter = $data['coolfilter'];		} else {			$coolfilter = 0;		}  			$currency_value = $this->currency->getValue();						$sql_add_table_prices = '';			$sql_where_prices = '';			$sql_where_manufacteurs = '';			$sql_add_table_options = '';			$sql_where_options = '';			$sql_add_table_attributes = '';			$sql_where_attributes = '';			//standart filter			$sql_add_table_parameters  = '';			$sql_where_parameters  = '';			//standart filter						if ($coolfilter) {									  foreach (explode(';', $coolfilter) as $option) {				$values = explode(':', $option);														if ($values[0] == 'm' && preg_match('/^[,0-9]+$/i', $values[1])) {					$sql_where_manufacteurs = ' AND p.manufacturer_id IN (' . $this->db->escape($values[1]) . ')';										}				if (preg_match('/o_\d+/', $values[0]) && preg_match('/^[,0-9]+$/i', $values[1])) {					$option_id = $this->db->escape($values[0]);					$sql_add_table_options .= ' LEFT JOIN ' . DB_PREFIX . 'product_option_value pov' . $option_id . ' ON (p.product_id = pov' . $option_id . '.product_id)';					$values[1] = preg_replace("/[^0-9\,]/", "", $values[1]);					$sql_where_options .= ' AND pov' . $option_id . '.option_value_id IN (' . $this->db->escape($values[1]) .') AND (pov' . $option_id . '.subtract=0 OR pov' . $option_id . '.subtract=1 AND pov' . $option_id . '.quantity > 0)';				}				if (preg_match('/a_\d+/', $values[0])) {					$attribute_id = $this->db->escape($values[0]);					$sql_add_table_attributes .= ' LEFT JOIN ' . DB_PREFIX . 'product_attribute atr' . $attribute_id . ' ON (p.product_id = atr' . $attribute_id . '.product_id)';					$get_id = explode("_", $values[0]);										$values[1] = explode(",", $values[1]);					for ($i = 0; $i < count($values[1]); $i++) {						$values[1][$i] = $this->db->escape($values[1][$i]);					}										$values[1] = "'" . implode("','", $values[1]) . "'";										$sql_where_attributes .= " AND (atr" . $attribute_id . ".language_id = '" . (int)$this->config->get('config_language_id') . "' AND atr" . $attribute_id . ".attribute_id = '" . (int)$get_id[1] . "' AND atr" . $attribute_id . ".text IN (" . $values[1] . "))";				}				if ($values[0] == 'p') {										$values[1] = explode(",", $values[1]);					if (!isset($values[1][0])) {						$values[1][0] = 0;					} else {						$values[1][0] = $values[1][0]/$currency_value;					}										if (!isset($values[1][1])) {						$values[1][1] = 9999999;					} else {						$values[1][1] = $values[1][1]/$currency_value;					}										for ($i = 0; $i < 2; $i++) {						$values[1][$i] = (float)$values[1][$i];					}										if (!empty($data['coolfilter_category_id'])) {						$category_id = ' AND ct.category_id IN (' . $data['coolfilter_category_id'] . ')';					} else {						$category_id = '';					}										$sql_add_table_prices  = " 									  LEFT JOIN " . DB_PREFIX . "product_discount pd2 ON p.product_id = pd2.product_id 										AND pd2.customer_group_id = '" . (int)$this->config->get('config_customer_group_id') . "' 										AND pd2.quantity <= '1' AND (pd2.date_start <= NOW() OR pd2.date_start = '0000-00-00') 										AND (pd2.date_end >= NOW() OR pd2.date_end = '0000-00-00') 									  LEFT JOIN " . DB_PREFIX . "product_special ps ON (p.product_id = ps.product_id) 										AND ps.customer_group_id = '" . (int)$this->config->get('config_customer_group_id') . "' 										AND (ps.date_start <= NOW() OR ps.date_start = '0000-00-00') 										AND (ps.date_end >= NOW() OR ps.date_end = '0000-00-00') 										     ";										 					$sql_where_prices  =  " AND LEAST(IF(p.price, p.price, 9999999), IF(pd2.price, pd2.price, 9999999), IF(ps.price, ps.price, 9999999)) >= '" .$values[1][0] . "' 											    AND LEAST(IF(p.price, p.price, 9999999), IF(pd2.price, pd2.price, 9999999), IF(ps.price, ps.price, 9999999)) <= '" .$values[1][1] . "'															                            AND p.status = '1' AND p.date_available <= NOW() ";											}												//standart filter														if (preg_match('/p_\d+/', $values[0]) && preg_match('/^[,0-9]+$/i', $values[1])) {					$parameter_id = $this->db->escape($values[0]);										$sql_add_table_parameters .= " LEFT JOIN " . DB_PREFIX . "product_filter par" . $parameter_id . " ON (p.product_id = par" . $parameter_id . ".product_id) LEFT JOIN  " . DB_PREFIX . "filter_description fd" . $parameter_id . "  ON (par" . $parameter_id . ".filter_id = fd" . $parameter_id . ".filter_id) ";					$get_id = explode("_", $values[0]);																			$values[1] = explode(",", $values[1]);					for ($i = 0; $i < count($values[1]); $i++) {						$values[1][$i] = $this->db->escape($values[1][$i]);																		}										$values[1] = "'" . implode("','", $values[1]) . "'";															$sql_where_parameters .= " AND (fd" . $parameter_id . ".language_id = '" . (int)$this->config->get('config_language_id') . "' AND par" . $parameter_id . ".filter_id IN (" . $values[1] . "))";// 					}				}															} 			// End coolfilter ]]></add>        </operation>        <operation>            <search position="after" index="3" offset="1"><![CDATA[$sql .= " FROM " . DB_PREFIX . "product p";]]></search>            <add><![CDATA[	// start coolfilter		$sql .= $sql_add_table_options;		$sql .= $sql_add_table_attributes;		$sql .= $sql_add_table_prices;		$sql .= $sql_add_table_parameters;		// End coolfilter		 ]]></add>        </operation>        <operation>            <search position="after" index="3" offset="1"><![CDATA[$sql .= " AND p.manufacturer_id = '" . (int)$data['filter_manufacturer_id'] . "'";]]></search>            <add><![CDATA[	   $sql .= $sql_where_manufacteurs;			$sql .= $sql_where_attributes;			$sql .= $sql_where_options;			$sql .= $sql_where_prices;			$sql .= $sql_where_parameters;		 ]]></add>        </operation>    </file>    <file name="catalog/language/english/product/category.php" error="log">        <operation>            <search position="before" index="1"><![CDATA[			$_['text_error']			]]></search>            <add trim="true"><![CDATA[			$_['text_all_products']	= 'All Products';			]]></add>        </operation>    </file>    <file name="catalog/language/russian/product/category.php" error="log">        <operation>            <search position="before" index="1"><![CDATA[			$_['text_error']			]]></search>            <add trim="true"><![CDATA[			$_['text_all_products']	= 'Все товары';			]]></add>        </operation>    </file>    <file name="catalog/view/theme/default/template/common/header.tpl" error="log">        <operation>            <search position="after" index="1"><![CDATA[			<link href="catalog/view/theme/default/stylesheet/stylesheet.css" rel="stylesheet">			]]></search>            <add trim="true"><![CDATA[			<link rel="stylesheet" type="text/css" href="catalog/view/theme/default/stylesheet/coolfilter.css" />			]]></add>        </operation>    </file>    <file name="catalog/controller/common/currency.php" error="log">        <operation>            <search position="after"><![CDATA[			if (isset($this->request->post['currency_code'])) {			]]></search>            <add trim="true"><![CDATA[			preg_match("{(coolfilter=[^&$]*?)p:([\d\.]+),([\d\.]+)}i", $this->request->post['redirect'], $price_matches);			$this->request->post['redirect'] = preg_replace("{(coolfilter=[^&$]*?)p:([\d\.]+),([\d\.]+)[;]*}i", "$1", $this->request->post['redirect']);			]]></add>        </operation>    </file></modification>